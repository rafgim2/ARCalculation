<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>AR MULTIMUSIC / Versión 2D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    /* Estilos comunes para el overlay de configuración (HTML 2D) */
    body { margin: 0; font-family: sans-serif; background: #222; color: #fff; }
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #aaf951;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }
    #overlay img { max-width: 80%; margin-bottom: 20px; border-radius: 10px; }
    #overlay input, #overlay select, #overlay button {
      font-size: 18px;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
    }
    #overlay button {
      background: green;
      color: #fff;
      cursor: pointer;
    }
    /* Estilos para la interfaz del juego en modo 2D */
    #gameContainer {
      display: none;
      width: 100%;
      height: 100vh;
      position: relative;
      text-align: center;
      padding-top: 20px;
      box-sizing: border-box;
    }
    #questionContainer { font-size: 2em; margin-bottom: 20px; }
    #answersContainer { margin-bottom: 20px; }
    #answersContainer button {
      font-size: 1.5em;
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
    }
    #infoContainer {
      font-size: 1.2em;
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Overlay de configuración (se muestra al cargar la página) -->
  <div id="overlay">
    <img src="ARCalc.jpeg" alt="ARCalc">
    <input type="text" id="playerName" placeholder="Ingresa tu nombre">
    <div>
      <label for="numAnswers">Número de respuestas: </label>
      <select id="numAnswers">
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
    </div>
    <button id="startButton">Iniciar Juego</button>
  </div>

  <!-- Contenedor del juego en modo 2D -->
  <div id="gameContainer">
    <div id="questionContainer">La pregunta aparecerá aquí</div>
    <div id="answersContainer"></div>
    <div id="infoContainer">
      <div id="countdownTimer">00:60</div>
      <div id="scoreDisplay">Aciertos: 0 | Fallos: 0</div>
    </div>
  </div>

  <script type="module">
    // Función para comprobar si AR es soportado
    async function isARSupported() {
      if (navigator.xr && navigator.xr.isSessionSupported) {
        try {
          return await navigator.xr.isSessionSupported("immersive-ar");
        } catch(e) {
          return false;
        }
      }
      return false;
    }

    // --- Rama AR (Three.js) ---
    async function runARVersion() {
      // Se elimina el overlay inicial (no se usará en 2D)
      const overlay = document.getElementById("overlay");
      if (overlay) overlay.remove();

      // Importamos Three.js y ARButton
      import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.module.js";
      import { ARButton } from "https://cdn.jsdelivr.net/npm/three@0.138.0/examples/jsm/webxr/ARButton.js";

      // Variables AR
      let camera, scene, renderer;
      let correctAnswer;
      let answers = [];
      let questionMesh = null;
      let questionText = "";
      const collisionThreshold = 0.2;
      let correctCount = 0, wrongCount = 0;
      let gameStartTime = 0;
      const gameDuration = 60;
      let gameOver = false;
      // (Otras variables y funciones para actualizar el countdown, score, etc.)
      
      // Inicialización de escena, cámara y renderer
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      
      // Agregar ARButton (posicionado en pantalla)
      const arButton = ARButton.createButton(renderer, { requiredFeatures: ["hit-test"] });
      arButton.style.position = "absolute";
      arButton.style.top = "450px";
      arButton.style.left = "calc(50% - 75px)";
      document.body.appendChild(arButton);
      
      // Aquí iría el resto de la lógica AR (generación de pregunta, respuestas, countdown, etc.)
      // Por motivos de extensión, se asume que el código AR original funciona y se basa en la lógica de la versión inicial.
      
      function animateAR() {
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
          // Aquí se incluirían actualizaciones de objetos, detección de colisiones, etc.
        });
      }
      animateAR();
    }

    // --- Rama 2D (usando HTML/CSS) ---
    function run2DVersion() {
      // En modo 2D usamos contenedores HTML; mostramos el overlay hasta que se pulse "Iniciar Juego"
      const overlay = document.getElementById("overlay");
      const gameContainer = document.getElementById("gameContainer");
      const questionContainer = document.getElementById("questionContainer");
      const answersContainer = document.getElementById("answersContainer");
      const countdownTimer = document.getElementById("countdownTimer");
      const scoreDisplay = document.getElementById("scoreDisplay");
      
      let playerName = "Jugador";
      let selectedNumAnswers = 4;
      let correctAnswer;
      let correctCount = 0, wrongCount = 0;
      let gameStartTime = 0;
      const gameDuration = 60; // segundos
      let currentQuestionStartTime = 0;
      let correctResponseTimes = [];
      
      function generateQuestion() {
        const ops = ["+", "-", "*"];
        let a, b, c, op1, op2, expr, structure;
        while (true) {
          a = Math.floor(Math.random()*10)+1;
          b = Math.floor(Math.random()*10)+1;
          c = Math.floor(Math.random()*10)+1;
          op1 = ops[Math.floor(Math.random()*ops.length)];
          op2 = ops[Math.floor(Math.random()*ops.length)];
          structure = Math.random() < 0.5 ? 0 : 1;
          if(structure === 0) {
            if(op1 === "-" && a < b) [a,b] = [b,a];
            let part1 = eval(`${a} ${op1} ${b}`);
            if(op2 === "-" && part1 < c) {
              if(part1 > 0) { c = Math.floor(Math.random()*part1)+1; }
              else continue;
            }
            expr = `(${a} ${op1} ${b}) ${op2} ${c}`;
          } else {
            if(op2 === "-" && b < c) [b,c] = [c,b];
            let part2 = eval(`${b} ${op2} ${c}`);
            if(op1 === "-" && a < part2) { a = Math.floor(Math.random()*10)+part2; }
            expr = `${a} ${op1} (${b} ${op2} ${c})`;
          }
          if(eval(expr) >= 0) break;
        }
        correctAnswer = eval(expr);
        questionContainer.textContent = "¿Cuánto es " + expr + "?";
        currentQuestionStartTime = performance.now();
        const options = generateOptions();
        answersContainer.innerHTML = "";
        options.forEach(option => {
          const btn = document.createElement("button");
          btn.textContent = option;
          btn.addEventListener("click", () => answerClicked(option));
          answersContainer.appendChild(btn);
        });
      }
      
      function generateOptions() {
        let options = [correctAnswer];
        while(options.length < selectedNumAnswers) {
          let wrong = Math.floor(Math.random()*100)+1;
          if(wrong !== correctAnswer && !options.includes(wrong)) {
            options.push(wrong);
          }
        }
        options.sort(() => Math.random()-0.5);
        return options;
      }
      
      function answerClicked(selected) {
        if(selected === correctAnswer) {
          correctCount++;
          let responseTime = performance.now() - currentQuestionStartTime;
          correctResponseTimes.push(responseTime);
        } else {
          wrongCount++;
        }
        updateScore();
        setTimeout(generateQuestion, 1000);
      }
      
      function updateScore() {
        scoreDisplay.textContent = "Aciertos: " + correctCount + " | Fallos: " + wrongCount;
      }
      
      let countdownInterval;
      function startCountdown() {
        gameStartTime = performance.now();
        countdownInterval = setInterval(() => {
          let elapsed = (performance.now()-gameStartTime)/1000;
          let remaining = Math.max(0, gameDuration - elapsed);
          let seconds = Math.floor(remaining);
          countdownTimer.textContent = "00:" + (seconds < 10 ? "0"+seconds : seconds);
          if(remaining <= 0) {
            clearInterval(countdownInterval);
            endGame();
          }
        }, 1000);
      }
      
      function endGame() {
        clearInterval(countdownInterval);
        answersContainer.innerHTML = "";
        questionContainer.textContent = "Juego Terminado";
        scoreDisplay.textContent = "Puntaje final: " + (correctCount - wrongCount);
      }
      
      // Configuración del botón de inicio (ya definido en el overlay)
      const startButton = document.getElementById("startButton");
      startButton.addEventListener("click", () => {
        playerName = document.getElementById("playerName").value || "Jugador";
        selectedNumAnswers = parseInt(document.getElementById("numAnswers").value) || 4;
        overlay.style.display = "none";
        gameContainer.style.display = "block";
        updateScore();
        generateQuestion();
        startCountdown();
      });
    }

    // --- Main: decidir entre AR y 2D ---
    (async function() {
      const arOK = await isARSupported();
      if(arOK) {
        // Ejecutar la versión AR (usando Three.js)
        runARVersion();
      } else {
        // Ejecutar la versión 2D (basada en HTML/CSS)
        run2DVersion();
      }
    })();
  </script>
</body>
</html>
