<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>MultiMusic - Juego 2D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body { margin: 0; font-family: sans-serif; background: #222; color: #fff; }
    /* Overlay inicial de configuración */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #aaf951;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }
    #overlay img { 
      max-width: 80%; 
      margin-bottom: 20px;
      border-radius: 10px;
    }
    #overlay input, #overlay select, #overlay button {
      font-size: 18px;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
    }
    #overlay button {
      background: green;
      color: #fff;
      cursor: pointer;
    }
    /* Contenedor del juego (inicialmente oculto) */
    #gameContainer {
      display: none;
      width: 100%;
      height: 100vh;
      position: relative;
      text-align: center;
      padding-top: 20px;
      box-sizing: border-box;
    }
    #questionContainer {
      font-size: 2em;
      margin-bottom: 20px;
    }
    #answersContainer {
      margin-bottom: 20px;
    }
    #answersContainer button {
      font-size: 1.5em;
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
    }
    #infoContainer {
      font-size: 1.2em;
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Overlay de configuración -->
  <div id="overlay">
    <img src="ARCalc.jpeg" alt="MultiMusic">
    <input type="text" id="playerName" placeholder="Ingresa tu nombre">
    <div>
      <label for="numAnswers">Número de respuestas: </label>
      <select id="numAnswers">
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
    </div>
    <button id="startButton">Iniciar Juego</button>
  </div>

  <!-- Contenedor del juego -->
  <div id="gameContainer">
    <div id="questionContainer">Pregunta aparecerá aquí</div>
    <div id="answersContainer"></div>
    <div id="infoContainer">
      <div id="countdownTimer">00:60</div>
      <div id="scoreDisplay">Aciertos: 0 | Fallos: 0</div>
    </div>
  </div>

  <script>
    // Variables globales del juego
    let playerName = "Jugador";
    let selectedNumAnswers = 4;
    let correctAnswer;
    let correctCount = 0, wrongCount = 0;
    let gameStartTime = 0;
    const gameDuration = 60; // segundos
    let countdownInterval;
    let currentQuestionStartTime = 0;
    let correctResponseTimes = [];

    // Referencias a contenedores HTML
    const overlay = document.getElementById("overlay");
    const startButton = document.getElementById("startButton");
    const gameContainer = document.getElementById("gameContainer");
    const questionContainer = document.getElementById("questionContainer");
    const answersContainer = document.getElementById("answersContainer");
    const countdownTimer = document.getElementById("countdownTimer");
    const scoreDisplay = document.getElementById("scoreDisplay");

    // Genera una pregunta aritmética aleatoria
    function generateQuestion() {
      const ops = ["+", "-", "*"];
      let a, b, c, op1, op2, expr, structure;
      while(true) {
        a = Math.floor(Math.random() * 10) + 1;
        b = Math.floor(Math.random() * 10) + 1;
        c = Math.floor(Math.random() * 10) + 1;
        op1 = ops[Math.floor(Math.random() * ops.length)];
        op2 = ops[Math.floor(Math.random() * ops.length)];
        structure = Math.random() < 0.5 ? 0 : 1;
        if(structure === 0) {
          if(op1 === "-" && a < b) { [a, b] = [b, a]; }
          let part1 = eval(`${a} ${op1} ${b}`);
          if(op2 === "-" && part1 < c) {
            if(part1 > 0) { c = Math.floor(Math.random() * part1) + 1; }
            else continue;
          }
          expr = `(${a} ${op1} ${b}) ${op2} ${c}`;
        } else {
          if(op2 === "-" && b < c) { [b, c] = [c, b]; }
          let part2 = eval(`${b} ${op2} ${c}`);
          if(op1 === "-" && a < part2) { a = Math.floor(Math.random() * 10) + part2; }
          expr = `${a} ${op1} (${b} ${op2} ${c})`;
        }
        // Evitamos respuestas negativas
        if(eval(expr) >= 0) break;
      }
      correctAnswer = eval(expr);
      return expr;
    }

    // Genera un arreglo de opciones (la correcta y varias incorrectas)
    function generateOptions() {
      let options = [];
      options.push(correctAnswer);
      while(options.length < selectedNumAnswers) {
        let wrong = Math.floor(Math.random() * 100) + 1;
        if(wrong !== correctAnswer && !options.includes(wrong)) {
          options.push(wrong);
        }
      }
      // Mezclar opciones
      options.sort(() => Math.random() - 0.5);
      return options;
    }

    // Muestra la pregunta y las respuestas en la pantalla
    function displayQuestion() {
      const expr = generateQuestion();
      questionContainer.textContent = "¿Cuánto es " + expr + "?";
      currentQuestionStartTime = performance.now();

      // Genera las opciones y crea botones
      const options = generateOptions();
      answersContainer.innerHTML = "";
      options.forEach(option => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.addEventListener("click", () => answerClicked(option));
        answersContainer.appendChild(btn);
      });
    }

    // Maneja el clic en una respuesta
    function answerClicked(selected) {
      // Prevenir múltiples clics
      if(selected == null) return;
      if(selected === correctAnswer) {
        correctCount++;
        const responseTime = performance.now() - currentQuestionStartTime;
        correctResponseTimes.push(responseTime);
      } else {
        wrongCount++;
      }
      updateScore();
      // Espera 1 segundo y genera una nueva pregunta
      setTimeout(displayQuestion, 1000);
    }

    // Actualiza la visualización del score
    function updateScore() {
      scoreDisplay.textContent = "Aciertos: " + correctCount + " | Fallos: " + wrongCount;
    }

    // Actualiza el cronómetro
    function startCountdown() {
      gameStartTime = performance.now();
      countdownInterval = setInterval(() => {
        let elapsed = (performance.now() - gameStartTime) / 1000;
        let remaining = Math.max(0, gameDuration - elapsed);
        let seconds = Math.floor(remaining);
        countdownTimer.textContent = "00:" + (seconds < 10 ? "0" + seconds : seconds);
        if(remaining <= 0) {
          clearInterval(countdownInterval);
          endGame();
        }
      }, 1000);
    }

    // Termina el juego y muestra el puntaje final
    function endGame() {
      // Detiene el cronómetro y deshabilita las respuestas
      clearInterval(countdownInterval);
      answersContainer.innerHTML = "";
      questionContainer.textContent = "Juego Terminado";
      scoreDisplay.textContent = "Puntaje final: " + (correctCount - wrongCount);
    }

    // Inicia el juego: oculta el overlay y muestra el contenedor del juego
    startButton.addEventListener("click", () => {
      playerName = document.getElementById("playerName").value || "Jugador";
      selectedNumAnswers = parseInt(document.getElementById("numAnswers").value) || 4;
      overlay.style.display = "none";
      gameContainer.style.display = "block";
      updateScore();
      displayQuestion();
      startCountdown();
    });
  </script>
</body>
</html>
